<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Danh Sách Dịch Vụ</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" href="/index_css.css">
<link rel="stylesheet" href="/popup_patients/popup.css">
</head>

<body>
	<!-- Sidebar -->
	<div id="sidebar">
		<div class="sidebar-header">
			<h3>Quản lý phòng khám</h3>
		</div>
		<ul class="list-unstyled components">
			<li><a th:href="@{/patients}">Quản lý bệnh nhân</a></li>
			<li><a href="#">Quản lý lịch khám</a></li>
			<li><a th:href="@{/services}">Quản lý dịch vụ</a></li>
			<li><a href="#">Quản lý hóa đơn</a></li>
		</ul>
	</div>

	<!-- Content -->
	<div class="content">
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">
				<a class="navbar-brand">Phòng Khám Nha Khoa</a>
				<button class="navbar-toggler" type="button"
					data-bs-toggle="collapse" data-bs-target="#navbarNav"
					aria-controls="navbarNav" aria-expanded="false"
					aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<div class="navbar-brand"
							th:if="${#authentication.name != 'anonymousUser'}">
							Welcome, <a th:text="${#authentication.principal.fullName}">User</a>
						</div>
						<li class="nav-item">
							<form th:action="@{/logout}" method="post">
								<button type="submit" class="btn btn-danger">Đăng xuất</button>
							</form>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="container my-4">
			<h1 class="text-center mb-3">Danh Sách Dịch Vụ</h1>

			<!-- Popup thêm dịch vụ -->
			<div id="addModal" class="modal">
				<div class="modal-content">
					<span class="close">&times;</span>
					<h2>Thêm Dịch Vụ</h2>
					<form id="addServiceForm" th:action="@{/services/add}"
						method="POST" th:object="${services}">
						<div class="mb-3">
							<label for="name" class="form-label">Tên Dịch Vụ</label> <input
								type="text" class="form-control" id="name" th:field="*{name}"
								required>
						</div>
						<div class="mb-3">
							<label for="description" class="form-label">Mô Tả</label>
							<textarea class="form-control" id="description"
								th:field="*{description}" required></textarea>
						</div>
						<div class="mb-3">
							<label for="price" class="form-label">Giá</label> <input
								type="number" class="form-control" id="price"
								th:field="*{price}" required>
						</div>
						<button type="submit" class="btn btn-primary">Gửi</button>
						<button type="button" class="btn btn-secondary" id="cancelAdd">Hủy</button>
					</form>
				</div>
			</div>

			<!-- Popup sửa dịch vụ -->
			<div id="editModal" class="modal">
				<div class="modal-content">
					<span class="closeEdit">&times;</span>
					<h2>Sửa Dịch Vụ</h2>
					<form id="editServiceForm" th:action="@{/services/edit}"
						method="POST">
						<input type="hidden" id="editId" name="id">
						<div class="mb-3">
							<label for="editName" class="form-label">Tên Dịch Vụ</label> <input
								type="text" class="form-control" id="editName" name="name"
								required>
						</div>
						<div class="mb-3">
							<label for="editDescription" class="form-label">Mô Tả</label>
							<textarea class="form-control" id="editDescription"
								name="description" required></textarea>
						</div>
						<div class="mb-3">
							<label for="editPrice" class="form-label">Giá</label> <input
								type="number" class="form-control" id="editPrice" name="price"
								required>
						</div>
						<button type="submit" class="btn btn-primary">Cập Nhật</button>
						<button type="button" class="btn btn-secondary" id="cancelEdit">Hủy</button>
					</form>
				</div>
			</div>

			<!-- Popup xác nhận xóa dịch vụ -->
			<div id="deleteModal" class="modal">
				<div class="modal-content">
					<span class="closeDelete">&times;</span>
					<h2>Xác nhận xóa dịch vụ</h2>
					<p>Bạn có chắc chắn muốn xóa dịch vụ này?</p>
					<form id="deleteServiceForm" method="POST">
						<input type="hidden" name="_csrf" value="CSRF_TOKEN_HERE">
						<!-- Token CSRF -->
						<input type="hidden" name="id" value="SERVICE_ID_HERE">
						<!-- ID dịch vụ -->
					</form>
					<button id="confirmDelete" class="btn btn-danger">Xóa</button>
					<button type="button" class="btn btn-secondary" id="cancelDelete">Hủy</button>
				</div>
			</div>


			<button class="btn btn-primary mb-3" id="openAddModal">Thêm
				Dịch Vụ</button>

			<table class="table table-bordered">
				<thead>
					<tr>
						<th>ID</th>
						<th>Tên Dịch Vụ</th>
						<th>Mô Tả</th>
						<th>Giá</th>
						<th>Hành Động</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="service : ${listServices}">
						<td th:text="${service.id}"></td>
						<td th:text="${service.name}"></td>
						<td th:text="${service.description}"></td>
						<td th:text="${service.price}"></td>
						<td>
							<button class="btn btn-sm btn-primary openEditModal"
								th:data-id="${service.id}" th:data-name="${service.name}"
								th:data-description="${service.description}"
								th:data-price="${service.price}">Sửa</button>
							<button class="btn btn-sm btn-danger openDeleteModal"
								th:data-id="${service.id}">Xóa</button>
						</td>
					</tr>
				</tbody>
			</table>
		</div>

		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
		<script>
            // Mở popup thêm dịch vụ
            document.getElementById("openAddModal").onclick = function() {
                document.getElementById("addModal").style.display = "block";
            };

            // Đóng popup khi nhấn vào nút "x"
            const closeAdd = document.getElementsByClassName("close")[0];
            closeAdd.onclick = function() {
                document.getElementById("addModal").style.display = "none";
            };

            // Đóng popup khi nhấn nút hủy
            document.getElementById("cancelAdd").onclick = function() {
                document.getElementById("addModal").style.display = "none";
           };

            // Mở popup sửa dịch vụ
            document.querySelectorAll(".openEditModal").forEach((btn) => {
                btn.onclick = function() {
                    const serviceId = this.getAttribute("data-id");
                    const serviceName = this.getAttribute("data-name");
                    const serviceDescription = this.getAttribute("data-description");
                    const servicePrice = this.getAttribute("data-price");

                    document.getElementById("editId").value = serviceId;
                    document.getElementById("editName").value = serviceName;
                    document.getElementById("editDescription").value = serviceDescription;
                    document.getElementById("editPrice").value = servicePrice;

                    document.getElementById("editModal").style.display = "block";
                };
            });

            // Đóng popup sửa khi nhấn vào nút "x"
            const closeEdit = document.getElementsByClassName("closeEdit")[0];
            closeEdit.onclick = function() {
                document.getElementById("editModal").style.display = "none";
            };

            // Đóng popup sửa khi nhấn nút hủy
            document.getElementById("cancelEdit").onclick = function() {
                document.getElementById("editModal").style.display = "none";
            };

            //sự kiện popup xóa dịch vụ
            document.addEventListener("DOMContentLoaded", function () {
                // Lấy các phần tử từ DOM
                const deleteModal = document.getElementById("deleteModal"); // Modal xóa
                const closeDelete = document.getElementsByClassName("closeDelete")[0];  // Nút đóng modal
                const cancelDelete = document.getElementById("cancelDelete");  // Nút hủy modal
                const deleteServiceForm = document.getElementById("deleteServiceForm");  // Form xóa dịch vụ

                // Gắn sự kiện cho tất cả các nút "Xóa"
                document.querySelectorAll(".openDeleteModal").forEach((btn) => {
			        btn.onclick = function () {
			            const serviceId = this.getAttribute("data-id");
			            if (serviceId) {
			                const csrfToken = document.querySelector('input[name="_csrf"]').value; 
			                deleteServiceForm.innerHTML = `
			                    <input type="hidden" name="_csrf" value="${csrfToken}">
			                    <input type="hidden" name="id" value="${serviceId}">
			                `;
			                deleteModal.style.display = "block";
			            } else {
			                alert("Không tìm thấy ID dịch vụ.");
			            }
			        };
			    });

                // Gắn sự kiện cho nút "Xóa" trong modal
                document.getElementById("confirmDelete").onclick = function () {
			        const serviceId = deleteServiceForm.querySelector('input[name="id"]').value; 
			        if (!serviceId) {
			            alert("Không thể xóa vì không tìm thấy ID dịch vụ!");
			            return;
			        }
			
			        fetch(`/services/delete/${serviceId}`, {
			            method: "DELETE",
			            headers: {
			                'Content-Type': 'application/json',
			                'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value 
			            }
			        })
			        .then(response => {
			            if (response.ok) {
			                return response.text(); 
			            } else {
			                throw new Error("Xóa dịch vụ không thành công!");
			            }
			        })
			        .then(message => {
			            alert(message); 
			            window.location.reload(); 
			        })
			        .catch(error => {
			            console.error("Error:", error);
			            alert("Đã xảy ra lỗi khi xóa dịch vụ!");
			        });
			    };

                // Đóng modal khi nhấn vào nút "x"
                closeDelete.onclick = function () {
                    deleteModal.style.display = "none";
                };

                // Đóng modal khi nhấn nút "Hủy"
                cancelDelete.onclick = function () {
                    deleteModal.style.display = "none";
                };

                // Đóng modal khi nhấn ra ngoài vùng nội dung
                window.onclick = function (event) {
                    if (event.target === deleteModal) {
                        deleteModal.style.display = "none";
                    }
                };
            });

            // Đóng popup khi nhấn ra ngoài vùng nội dung
            window.onclick = function(event) {
                if (event.target === document.getElementById("addModal")) {
                    document.getElementById("addModal").style.display = "none";
                }
                if (event.target === document.getElementById("editModal")) {
                    document.getElementById("editModal").style.display = "none";
                }
                if (event.target === document.getElementById("deleteModal")) {
                    document.getElementById("deleteModal").style.display = "none";
                }
            };
        </script>
	</div>
</body>
</html>